<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<LINK REL="stylesheet" HREF="../../../style.css">
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.66">
 <TITLE>DOMjudge Administrator's Manual: Installation and configuration </TITLE>
 <LINK HREF="admin-manual-4.html" REL=next>
 <LINK HREF="admin-manual-2.html" REL=previous>
 <LINK HREF="admin-manual.html#toc3" REL=contents>
</HEAD>
<BODY>
<A HREF="admin-manual-4.html">Next</A>
<A HREF="admin-manual-2.html">Previous</A>
<A HREF="admin-manual.html#toc3">Contents</A>
<HR>
<H2><A NAME="install_config"></A> <A NAME="s3">3.</A> <A HREF="admin-manual.html#toc3">Installation and configuration </A></H2>

<P>This chapter details a fresh installation of DOMjudge. The first
section is a Quick Installation Reference, but that should only be
used by those already acquainted with the system. A detailed guide
follows after that.</P>


<H2><A NAME="ss3.1">3.1</A> <A HREF="admin-manual.html#toc3.1">Quick installation</A>
</H2>

<P><EM>Note:</EM> this is not a replacement for the thorough installation
instructions below, but more a cheat-sheet for those who've already
installed DOMjudge before and need a few hints. When in doubt, always
consult the full installation instruction.</P>

<P>External software:
<UL>
<LI> Install the MySQL-server and set a root password for it.</LI>
<LI> Install Apache, PHP and (recommended) phpMyAdmin.</LI>
<LI> Make sure PHP works for the web server and command line scripts.</LI>
<LI> Install necessary compilers on the judgehosts.</LI>
<LI> See also 
<A HREF="#install_config:apt-getinstall">an example command line for Debian GNU/Linux</A>.</LI>
</UL>
</P>
<P>DOMjudge:
<UL>
<LI> Extract the source tarball and run <CODE>./configure
[--enable-fhs] --prefix=&lt;basepath&gt;</CODE>.</LI>
<LI> Run <CODE>make domserver judgehost docs</CODE> or just those
targets you want installed on the current host.</LI>
<LI> Run <CODE>make install-{domserver,judgehost,docs}</CODE>
as root to install the system.</LI>
</UL>

On the domserver host:
<UL>
<LI> Install the MySQL database using <CODE>bin/dj-setup-database -u root -r
install</CODE> on the domserver host.</LI>
<LI> Add <CODE>etc/apache.conf</CODE> to your Apache configuration, edit
it to your needs, reload web server:
<CODE>sudo ln -s .../domserver/etc/apache.conf /etc/apache2/conf.d/domjudge.conf &amp;&amp;
sudo apache2ctl graceful</CODE></LI>
<LI> Check that the web interface works (/team, /public and /jury).</LI>
<LI> Change the admin password from its default value.</LI>
<LI> Check that the API (/api) works and create credentials for the judgehosts.</LI>
<LI> Create accounts and add useful contest data through the jury web
interface or with phpMyAdmin.</LI>
<LI> Run the config checker in the jury web interface.</LI>
</UL>

On the judgehosts:
<UL>
<LI> RedHat: <CODE>useradd -d /nonexistent -g nobody -M -n -s /bin/false domjudge-run</CODE><BR>
Debian: <CODE>useradd -d /nonexistent -g nogroup -s /bin/false domjudge-run</CODE><BR>
(check specific options of useradd, since these vary per system)</LI>
<LI> Add to <CODE>/etc/sudoers.d/</CODE> or append to <CODE>/etc/sudoers</CODE> the
sudoers configuration as in <CODE>etc/sudoers-domjudge</CODE>.</LI>
<LI> Put the right credentials in the file <CODE>etc/restapi.secret</CODE>
on all judgehosts.</LI>
<LI> Optionally build a chroot to support interpreted or
byte-compiled langauges such as Java, see the appendix on
<A HREF="admin-manual-8.html#problems:java-chroot">setting up a chroot</A>.</LI>
<LI> Start the judge daemon: <CODE>bin/judgedaemon</CODE></LI>
</UL>

It should be done by now. As a check that (almost) everything works,
the set of test sources can be submitted:
<HR>
<PRE>
cd tests
make check
</PRE>
<HR>

Note that this requires <CODE>AUTH_METHOD</CODE> in
<CODE>etc/domserver-config.php</CODE> to be configured to
<CODE>IPADDRESS</CODE> or <CODE>FIXED</CODE>, such that one user/team has
passwordless access to the web interface. You may also want to set the
environment variable <CODE>SUBMITBASEURL</CODE> to your DOMjudge base URL,
e.g. <CODE>http://domjudge.example.com/</CODE>.</P>
<P>Then, in the main jury web interface, select the admin link
<I>judging verifier</I> to automatically verify most of the
test sources, except for a few with multiple possible outcomes; these
have to be verified by hand. Read the test sources for a description of
what should (not) happen.</P>
<P>Optionally:
<UL>
<LI> Install the submit client on the team workstations.</LI>
<LI> Generate passwords for all the teams in the web interface.</LI>
<LI> Further tighten the security of the system, e.g. by applying
firewall rules.</LI>
<LI> Start the balloon notification daemon: <CODE>cd bin; ./balloons</CODE>;
or use the balloon web interface.</LI>
<LI> Setup the Java chroot environment on the judgehosts to use Java with chroot:<BR>
<CODE>bin/dj_make_chroot &lt;chrootdir&gt; &lt;architecture&gt;</CODE><BR>
<CODE>$EDITOR lib/judge/chroot-startstop.sh</CODE><BR>
enable the <CODE>chroot-startstop.sh</CODE> script in <CODE>etc/judgehost-config.php</CODE>
and add <CODE>etc/sudoers-domjudge</CODE> to <CODE>/etc/sudoers.d/</CODE> or
append it to <CODE>/etc/sudoers</CODE>.</LI>
<LI> Set up cgroup support in the judgedaemons.
</LI>
<LI> For additional features in the jury web interface, the
following PHP extensions can be installed:
<UL>
<LI>xdiff PECL extension for diffs between submissions;</LI>
<LI>zip PHP-bundled extension (<CODE>--enable-zip</CODE>)
for uploading problem data as zip-bundles (enabled
by default in Debian, but not in all other Linux
distributions).</LI>
</UL>
</LI>
</UL>
</P>



<H2><A NAME="ss3.2">3.2</A> <A HREF="admin-manual.html#toc3.2">Prerequisites</A>
</H2>

<P>For a detailed list of the hardware and software requirements,
please refer to the previous chapter on contest planning.</P>
<P>
<A NAME="install_config:apt-getinstall"></A> </P>
<H3>Debian installation command</H3>


<P>For your convenience, the following command will install needed
software on the DOMjudge server as mentioned above when using Debian
GNU/Linux, or one of its derivate distributions like Ubuntu.</P>
<P>
<HR>
<PRE>
apt-get install gcc g++ make mysql-server \
        apache2 php5 php5-cli libapache2-mod-php5 php5-mysql php5-json \
        php-geshi phpmyadmin ntp \
        libboost-regex-dev libgmp3-dev linuxdoc-tools linuxdoc-tools-text \
        transfig groff texlive-latex-recommended texlive-latex-extra \
        texlive-fonts-recommended
</PRE>
<HR>
</P>
<P>On a judgehost, the following should be sufficient. The last line shows some
example compilers to install for C, C++, Java (GNU), Java (Oracle), Haskell
and Pascal; change the list as appropriate.</P>
<P>
<HR>
<PRE>
apt-get install make sudo php5-cli php5-curl php5-json procps \
        gcc g++ gcj openjdk-6-jre-headless openjdk-6-jdk ghc fp-compiler
</PRE>
<HR>
</P>
<P>Finally, to build the command-line submit client, install the
following additional software. Note that the submit client can only be
used when the <CODE>IPADDRESS</CODE> authentication method is used.</P>
<P>
<HR>
<PRE>
apt-get install libcurl4-gnutls-dev libjsoncpp-dev libmagic-dev
</PRE>
<HR>
</P>
<P>LibcURL is required for submitting via the web interface, the other
libraries are not strictly required, but highly recommended for
optimal functioning. These libraries are statically linked into the
<CODE>submit</CODE> binary so that these libraries are not needed on the
team workstations where <CODE>submit</CODE> is installed.</P>


<H2><A NAME="install_config:installsystem"></A> <A NAME="ss3.3">3.3</A> <A HREF="admin-manual.html#toc3.3">Installation system </A>
</H2>


<P>The DOMjudge build/install system consists of a <CODE>configure</CODE>
script and makefiles, but when installing it, some more care has to be
taken than simply running '<CODE>./configure &amp;&amp; make &amp;&amp;
make install</CODE>'. DOMjudge needs to be installed both on the server
and on the judgehosts. These require different parts of the complete
system to be present and can be installed separately. Within the build
system these parts are referred to as <CODE>domserver, judgehost</CODE>
and additionally <CODE>docs</CODE> for all documentation.</P>

<P>There are three different methods for installing DOMjudge:
<DL>
<DT><B>Single directory tree</B><DD>
<P>With this method all DOMjudge related files and programs are
installed in a single directory tree which is specified by the
prefix option of configure, like
<HR>
<PRE>
./configure --prefix=$HOME/domjudge
</PRE>
<HR>

This will install each of the <CODE>domserver, judgehost,
docs</CODE> parts in a subdirectory
<CODE>$HOME/domjudge/domserver</CODE> etc. These
subdirectories can be overridden from the defaults with options
like <CODE>--with-domserver_root=DIR</CODE>, see <CODE>configure
--help</CODE> for a complete list. The prefix defaults to
<CODE>/opt/domjudge</CODE>.</P>
<P>Besides the installed files, there will also be directories
for logging, temporary files, submitted sources and judging
data:
<DL>
<DT><B><CODE>log</CODE></B><DD>
<P>contains all log files.</P>
<DT><B><CODE>tmp</CODE></B><DD>
<P>contains temporary files.</P>
<DT><B><CODE>submissions</CODE></B><DD>
<P>(optionally) on the domserver contains all correctly
submitted files: as backup only, the database is the
authoritative source. Note that this directory must be
writable by the web server for this feature to work.</P>
<DT><B><CODE>judgings</CODE></B><DD>
<P>location on judgehosts where submissions are tested,
each in its own subdirectory.</P>
</DL>
</P>
<P>This method of installation is the default and probably most
practical for normal purposes as it keeps all files together,
hence easily found.</P>

<DT><B>FHS compliant</B><DD>
<P>This method installs DOMjudge in directories according to the
<A HREF="http://www.pathname.com/fhs/">Filesystem Hierarchy Standard</A>. It can be enabled by
passing the option <CODE>--enable-fhs</CODE> to <CODE>configure</CODE>
and in this case the prefix defaults to <CODE>/usr/local</CODE>.
Files will be placed e.g. in <CODE>PREFIX/share/domjudge,
PREFIX/bin, /var/log, /tmp, /etc/domjudge</CODE>.</P>

<DT><B>Maintainer install</B><DD>
<P>Meant for those wishing to do development on the DOMjudge
source code. See the 
<A HREF="admin-manual-11.html#appendix:developerinfo">appendix with developer information</A>.</P>
</DL>
</P>
<P>After running the <CODE>configure</CODE> script, the system can be built
and installed. Each of the <CODE>domserver, judgehost, docs</CODE> parts
can be built and installed separately, respectively by:
<HR>
<PRE>
make domserver &amp;&amp; sudo make install-domserver
make judgehost &amp;&amp; sudo make install-judgehost
make docs &amp;&amp; make install-docs
</PRE>
<HR>

Note that even when installing e.g. in your own home directory, root
privileges are still required for domserver and judgehost
installation, because user and group ownership of password files, some
directories and to give sudo access to <CODE>runguard</CODE>. One should
<EM>not</EM> run DOMjudge programs and daemons under the root user
however, but under a normal user: <CODE>runguard</CODE> is specifically
designed to be the only part invoked as root (through sudo) to make
this unnecessary and running as root
will give rise to problems, see 
<A HREF="admin-manual-8.html#runguard-rootprivs">runguard: root privileges not dropped</A> in the common problems
section.</P>
<P>For a list of basic make targets, run <CODE>make</CODE> in the source root
directory without arguments.</P>

<H2><A NAME="ss3.4">3.4</A> <A HREF="admin-manual.html#toc3.4">Configuration</A>
</H2>


<P>Configuration of the judge system is mostly done by editing the
configuration variables on the page <CODE>Configuration settings</CODE>
available in the administrator interface. Changes take effect immediately.</P>
<P>Some settings that are tightly coupled to the filesystem can be
configured in the files in <CODE>etc</CODE>: <CODE>domserver-config.php,
judgehost-config.php, common-config.php</CODE> for the configuration
options of the domserver, judgehost and shared configuration options
respectively. The latter should be synchronised between domserver and
judgehosts. Descriptions of settings are included in these files.
The judgedaemon must be restarted for changes to take effect, while
these are directly picked up by the webinterfaces.</P>
<P>Besides these settings, there are a few other places where changes can
be made to the system, see 
<A HREF="#install_config:configurablescripts">other configurable scripts</A>.</P>


<H2><A NAME="ss3.5">3.5</A> <A HREF="admin-manual.html#toc3.5">Configuration of languages</A>
</H2>


<P>Configuration of the compilers of the supported languages should be
done separately. For each supported language a shell-script named
<CODE>compile_&lt;lang&gt;.sh</CODE> should be created and placed in
<CODE>lib/judge</CODE> on the judgehosts, where &lt;lang&gt; is the ID of
the language as specified in the database. For more information, see
for example <CODE>compile_c.sh</CODE>, and <CODE>compile.sh</CODE> in
<CODE>lib/judge</CODE> for syntax. Note that compile scripts are included
for the most common languages already.</P>
<P>Interpreted languages and non-statically linked binaries can in
principle also be used, but requires that all dependencies are added
to the chroot environment.</P>
<P>Interpreted languages do not generate an executable and in principle
do not need a compilation step. However, to be able to use interpreted
languages (also Oracle's Java), a script must be generated during the
compilation step, which will function as the executable: the script
must run the interpreter on the source. See <CODE>compile_perl.sh</CODE>
and <CODE>compile_java_javac.sh</CODE> in <CODE>lib/judge</CODE> for
examples.</P>
<P>DOMjudge supports the use of Oracle Java within a chroot environment. For
this, a chroot environment which includes the Java libraries must
first be built. This can be accomplished with the included script
<CODE>dj_make_chroot</CODE>: run this as root and pass as arguments
the target directory to build the chroot environment in and as second
argument the target machine architecture. Start the script without
arguments for usage information. See also sections
<A HREF="#install_config:judgehost">Installation of a judgehost</A>
and 
<A HREF="admin-manual-8.html#problems:java-chroot">Problems: Java &amp; chroot</A>.</P>

<H2><A NAME="ss3.6">3.6</A> <A HREF="admin-manual.html#toc3.6">Configuration of special run and compare programs</A>
</H2>


<P>To allow for problems that do not fit within the standard scheme of
fixed input and/or output, DOMjudge has the possibility to change the
way submissions are run and checked for correctness.</P>
<P>The back end script <CODE>testcase_run.sh</CODE> that handles
the running and checking of submissions, calls separate programs
for running submissions and comparison of the results. These can be
specialised and adapted to the requirements per problem. For this, one
has to create programs or scripts named <CODE>run_&lt;tag&gt;</CODE> and/or
<CODE>compare_&lt;tag&gt;</CODE> in the <CODE>lib/judge</CODE>
directory, see <CODE>run</CODE> and <CODE>compare</CODE> for examples and
usage information. Then the <CODE>&lt;tag&gt;</CODE> must be
specified in the <CODE>special_run</CODE> and/or <CODE>special_compare</CODE>
fields of the problem (an empty value means that the default run and
compare scripts should be used). To simplify the use of custom run and
compare programs, DOMjudge comes with wrapper scripts that handle the
tedious, standard part. In most cases it will probably be convenient
to use these, see <CODE>run_wrapper</CODE> and <CODE>compare_wrapper</CODE>
for details, and the usage explanations below.</P>

<H3>Compare programs</H3>


<P>Implementing a special compare program, also called a
<EM>validator</EM>, can be done by writing a program that's run by
the <CODE>compare_wrapper</CODE> script.</P>
<P>Use this wrapper by copying or symlinking it to <CODE>compare_&lt;tag&gt;</CODE>
and let the jury write a checker program which can be called as
<HR>
<PRE>
check_&lt;tag> &lt;testdata.in> &lt;program.out> &lt;testdata.out>
</PRE>
<HR>

This program should write some kind of difference to stdout. No
output from the checker program results in a <EM>correct</EM> verdict
and a nonzero exitcode in
an internal (system) error. See as an example the included program
<CODE>check_float</CODE>, which compares floating point numbers. The name
of the check program and any parameters can also be modified in the
<CODE>compare_wrapper</CODE> script.</P>
<P>For example, to compare output while ignoring DOS/UNIX newline
differences, one can copy <CODE>compare_wrapper</CODE> to
<CODE>compare_dos_newline_OK</CODE> and in that file set the variable
<CODE>CHECK_PROGRAM="`which diff`"</CODE> and replace the line
<HR>
<PRE>
"$CHECK_PROGRAM" $CHECK_OPTIONS "$TESTIN" "$PROGRAM" "$TESTOUT" > "$DIFFOUT"
</PRE>
<HR>

by the lines
<HR>
<PRE>
sed -i 's/\r$//' "$TESTOUT"
sed 's/\r$//' "$PROGRAM" | $CHECK_PROGRAM -a - "$TESTOUT" > "$DIFFOUT"
</PRE>
<HR>

Note that these commands will modify the local copy of the jury
testdata, but the original output generated by the team's solution is
retained, and a plain diff output is generated. Next, for each problem
that you want to use this validator for, set the
<CODE>special_compare</CODE> field to <CODE>dos_newline_OK</CODE>. As an
alternative to this modified validator script, one can accept
presentation errors as correct answers by adding the mapping
<HR>
<PRE>
        'presentation-error' => 'correct',
</PRE>
<HR>

to the <CODE>results_remap</CODE> configuration variable (to be found in
the admin web interface under <EM>configuration settings</EM>).</P>
<P>For more details on modifying validator scripts, see the comments at the top
of the files <CODE>testcase_run.sh</CODE> and <CODE>compare_wrapper</CODE>.</P>
<P>DOMjudge supports a <CODE>presentation-error</CODE> result. The default
<CODE>compare</CODE> program returns this result when output only differs
by whitespace; this is counted as an incorrect submission. The script
<CODE>compare_wrapper</CODE> does not support presentation error results
however. By default presentation errors are remapped to wrong answer;
this can be changed with <CODE>results_remap</CODE>.</P>

<H3>Run programs</H3>


<P>Special run programs can be used, for example, to create an interactive
problem, where the contestants' program exchanges information with a
jury program and receives data depending on its own output. The
problem <CODE>boolfind</CODE> is included as an example interactive
problem, see <CODE>docs/examples/boolfind.pdf</CODE> for the description.</P>
<P>Usage is similar to compare programs: you can either create a program
<CODE>run_&lt;tag&gt;</CODE> yourself, or use the provided wrapper
script, which handles bi-directional communication between a
jury program and the contestants' program on stdin/stdout.</P>
<P>For the first case, the calling syntax that the program must accept is
equal to the calling syntax of <CODE>run_wrapper</CODE>, which is
documented in that file. When using <CODE>run_wrapper</CODE>, you should
copy or symlink it to another name <CODE>run_&lt;tag&gt;</CODE> and
the jury must write a program named exactly <CODE>runjury_&lt;tag&gt;</CODE>,
accepting the calling syntax
<HR>
<PRE>
runjury_&lt;tag> &lt;testdata.in> &lt;program.out>
</PRE>
<HR>

where the arguments are files to read input testdata from and write
program output to, respectively. This program will communicate via
stdin/stdout with the contestants' program. A special compare program
must probably also be created, so the exact data written to
<CODE>&lt;program.out&gt;</CODE> is not important, as long as the
correctness of the contestants' program can be deduced from the
contents by the compare program.</P>


<H2><A NAME="ss3.7">3.7</A> <A HREF="admin-manual.html#toc3.7">Alerting system</A>
</H2>


<P>DOMjudge includes an alerting system. This allows the administrator to
receive alerts when important system events happen, e.g. an error
occurs, or a submission or judging is made.</P>
<P>These alerts are passed to a plugin script <CODE>alert</CODE> which can
easily be adapted to fit your needs. The default script emits
different beeping sounds for the different messages when the
<CODE>beep</CODE> program is available, but it could for example also be
modified to send a mail on specific issues, connect to monitoring
software like Nagios, etc. For more details, see the script
<CODE>lib/alert</CODE>.</P>

<H2><A NAME="install_config:configurablescripts"></A> <A NAME="ss3.8">3.8</A> <A HREF="admin-manual.html#toc3.8">Other configurable scripts</A>
</H2>


<P>There are a few more places where some configuration of the system can
be made. These are sometimes needed in non-standard environments.
<UL>
<LI> In <CODE>bin/dj_make_chroot</CODE> on a judgehost some changes to
variables can be made, most notably <CODE>DEBMIRROR</CODE> to
select a Debian mirror site near you.</LI>
<LI> Optional scripts <CODE>submit/submit_copy.sh</CODE> and
<CODE>lib/judge/chroot-startstop.sh</CODE> can be modified
to suit your local environment. See comments in those files for
more information.</LI>
</UL>
</P>

<H2><A NAME="install_config:submissionmethods"></A> <A NAME="ss3.9">3.9</A> <A HREF="admin-manual.html#toc3.9">Submission methods </A>
</H2>


<P>DOMjudge supports two submission methods: via the command line submit
program and via the web interface. From experience, both methods have
users that prefer the one above the other. Note that the submit client
can only be used when the <CODE>IPADDRESS</CODE> authentication method is
used.</P>
<P>The command line submit client can send submissions by either using
the web interface internally (<EM>http</EM> protocol, the default),
or using a special command line submit protocol, called
<EM>Dolstra</EM>. The latter has some special features but is not
usually needed. See 
<A HREF="admin-manual-10.html#dolstra">Submitdaemon and the Dolstra protocol</A> for
details on this.</P>
<P>Using the http protocol with the submit client requires the libcURL
library development files at compile time (the submit client is
statically linked to libcURL to avoid a runtime dependency).</P>
<P>The database is the authoritative version for submission sources;
file system storage is available as an easy way
to access the source files and as backup. The program
<CODE>bin/restore_sources2db</CODE> is available to recover the submission
table in the database from these files. The command line daemon will
automatically store sources on the file system; the web server needs
write permissions on <CODE>&lt;domjudge_submitdir&gt;</CODE> and ignores
file system storage if these permissions are not set.</P>

<H2><A NAME="ss3.10">3.10</A> <A HREF="admin-manual.html#toc3.10">Database installation</A>
</H2>


<P>DOMjudge uses a MySQL or MariaDB database server for information storage.
Where this document talks about MySQL, it can be understood to also apply
to MariaDB.</P>
<P>The database structure and privileges are included in MySQL
dump files in the sql subdirectory. The default database name is
<CODE>domjudge</CODE>. This can be changed manually in the
<CODE>etc/dbpasswords.secret</CODE> file: the database name as specified
in this file will be used when installing.</P>
<P>Installation of the database is done with <CODE>bin/dj-setup-database</CODE>.
For this, you need an installed and configured MySQL server and
administrator access to it. Run
<HR>
<PRE>
dj-setup-database genpass
dj-setup-database [-u &lt;admin_user>] [-p &lt;password>|-r] install
</PRE>
<HR>

This first creates the DOMjudge database credentials file
<CODE>etc/dbpasswords.secret</CODE> (optionally change the random
generated password, although it is not needed for normal operation).
Then it creates the database and user and inserts some
default/example data into the domjudge database. The option
<CODE>-r</CODE> will prompt for a password for mysql; when no user is
specified, the mysql client will try to read
credentials from <CODE>$HOME/.my.cnf</CODE> as usual. The command
<CODE>uninstall</CODE> can be passed to <CODE>dj-setup-database</CODE> to
remove the DOMjudge database and users; <EM>this deletes all data!</EM></P>
<P>The domjudge database contains a number of tables, some of which need
to be manually filled with data before the contest can be run. See the
<A HREF="admin-manual-4.html#contestsetup:database">database section of Contest setup</A> for details.</P>

<H3>Fine tuning settings</H3>

<P>For Apache, there are countless documents on how to maximise performance.
Of particular importance is to ensure that the <CODE>MaxClients</CODE> setting
is high enough to receive the number of parallel requests you expect, but
not higher than your amount of RAM allows.</P>

<P>As for PHP, the use of an opcode cache like the Alternative PHP Cache
(Debian package: <CODE>php-apc</CODE>) is beneficial for performance. For
uploading large testcases, see the
<A HREF="admin-manual-8.html#problems:memory">section about memory limits</A>.</P>

<P>It may be desirable or even necessary to fine tune some MySQL default settings:</P>
<P>
<UL>
<LI><CODE>max_connections</CODE>: The default 100 is too low, because of the
connection caching by Apache threads. 1000 is more appropriate.</LI>
<LI><CODE>max_allowed_packet</CODE>: The default of 16MB might be too
low when using large testcases. This should be changed both in the
MySQL server and client configuration and be set to about twice the
maximum testcase size.</LI>
<LI>Root password: MySQL does not have a password for the root user
by default. It's very desirable to set one.</LI>
<LI>When maximising performance is required, you can
consider to use the <EM>Memory</EM> table storage engine
for the scorecache_public and scorecache_jury tables. They will be
lost in case of a full crash, but can be recalculated from the jury
interface.</LI>
</UL>
</P>

<H3>Setting up replication or backups</H3>

<P>The MySQL server is the central place of information storage for
DOMjudge. Think well about what to do if the MySQL
host fails or loses your data.</P>
<P>A very robust solution is to set up a replicating MySQL server on
another host. This will be a hot copy of all data up to the second,
and can take over immediately in the event of failure. The MySQL manual
has more information about setting this up.</P>
<P>Alternatively, you can make regular backups of your data to another host,
for example with <CODE>mysqldump</CODE>, or use a RAID based system.</P>
<P>Replication can also be used to improve performance, by directing all
select-queries to one or more replicated slave servers, while updates
will still be done to the master. This is not supported out of the box,
and will require making changes to the DOMjudge source.</P>

<H2><A NAME="ss3.11">3.11</A> <A HREF="admin-manual.html#toc3.11">Web server configuration</A>
</H2>


<P>For the web interface, you need to have a web server (e.g. Apache)
installed on the domserver and made sure that PHP correctly works
with it. Refer to the documentation of your web server and PHP for
details.</P>
<P>You should turn PHP's <CODE>magic_quotes_*</CODE> options off. We
also recommend to turn off <CODE>register_globals</CODE>.</P>
<P>To configure the web server for DOMjudge, use the Apache configuration
snippet from <CODE>etc/apache.conf</CODE>. It contains examples for
configuring the DOMjudge pages with an alias directive, or as a
virtualhost, optionally with SSL; it also contains PHP and security
settings. Reload the web server for changes to take effect.</P>
<P>The judgehosts connect to DOMjudge via the DOMjudge API so need
to be able to access at least this part of the web interface.</P>

<H2><A NAME="ss3.12">3.12</A> <A HREF="admin-manual.html#toc3.12">Logging &amp; debugging</A>
</H2>


<P>All DOMjudge daemons and web interface scripts support logging and
debugging in a uniform manner via functions in <CODE>lib.error.*</CODE>.
There are three ways in which information is logged:
<UL>
<LI>Directly to <CODE>stderr</CODE> for daemons or to the web page for
web interface scripts (the latter only on serious issues).</LI>
<LI>To a log file set by the variable <CODE>LOGFILE</CODE>, which is set
in each program. Unsetting this variable disables this method.</LI>
<LI>To syslog. This can be configured via the <CODE>SYSLOG</CODE>
configuration variable in <CODE>etc/common-config.php</CODE>. This
option gives the flexibility of syslog, such as remote logging.
See the syslog(daemon) documentation for more information.
Unsetting this variable disables this method.</LI>
</UL>

Each script also defines a default threshold level for messages to be
logged to stderr (<CODE>VERBOSE</CODE>: defaults to <CODE>LOG_INFO</CODE> in
daemons and <CODE>LOG_ERR</CODE> in the web interface) and for
log file/syslog (<CODE>LOGLEVEL</CODE>: defaults to <CODE>LOG_DEBUG</CODE>).</P>
<P>In case of problems, it is advisable to check the logs for clues.
Extra debugging information can be obtained by setting the config
option <CODE>DEBUG</CODE> to a bitwise-or of the available
<CODE>DEBUG_*</CODE> flags in <CODE>etc/common-config.php</CODE>, to e.g.
generate extra SQL query and timing information in the web interface.</P>

<H2><A NAME="install_config:judgehost"></A> <A NAME="ss3.13">3.13</A> <A HREF="admin-manual.html#toc3.13">Installation of a judgehost</A>
</H2>


<P>A few extra steps might need to be taken to completely install and
configure a judgehost.</P>
<P>For running solution programs under a non-privileged user, a user has
to be added to the system(s) that act as judgehost. This user does not
need a home-directory or password, so the following command would
suffice to add a user `domjudge-run' with minimal privileges.</P>
<P>On RedHat:
<PRE>
useradd -d /nonexistent -g nobody -M -n -s /bin/false domjudge-run
</PRE>

On Debian:
<PRE>
useradd -d /nonexistent -g nogroup -s /bin/false domjudge-run
</PRE>
</P>
<P>For other systems check the specifics of your useradd command.
This user must also be configured as the user under which programs run
via <CODE>configure --enable-runuser=USER</CODE>; the default is
<CODE>domjudge-run</CODE>.</P>
<P><CODE>Runguard</CODE> needs to be able to become root for certain operations
like changing to the runuser and performing a chroot. Also, the default
<CODE>chroot-startstop.sh</CODE> script uses sudo to gain privileges for
certain operations. There's a pregenerated <CODE>/etc/sudoers.d/</CODE> snippet
in <CODE>etc/sudoers-domjudge</CODE> that contains all required rules. You can
put the lines in the snippet at the end of  <CODE>/etc/sudoers</CODE>, or, for
modern sudo versions, place the file in <CODE>/etc/sudoers.d/</CODE>. If you
change the user you run the judgehost at, or the installation paths, be
sure to update the sudoers rules accordingly.</P>
<P>When the chroot setting is enabled (default), a static POSIX shell has
to be available for copying it to the chroot environment. For Linux
i386, a static Dash shell is included, which works out of the box. For
other architectures or operating systems, a shell has to be added
manually. Then simply point the <CODE>lib/sh-static</CODE> symlink to this
file. If you want to support languages that cannot be compiled to
statically linked binaries, e.g. byte-compiled languages such as Java,
or interpreted languages such as Python, then a complete chroot
environment must be built and configured. See the appendix on
<A HREF="admin-manual-8.html#problems:java-chroot">setting up a chroot</A> for more
details.</P>
<P>The judgehost connects to the domserver via a REST API. You need to
create an account for the judgedaemons to use (this may be a
shared account between all judgedaemons) with a difficult,
random password and the 'judgehost' role. On each judgedaemon,
create a file <CODE>etc/restapi.secret</CODE> containing the URL,
username and password whitespace-separated on one line, for example:
<PRE>
http://example.edu/domjudge/api/  judgehosts  MzfJYWF5agSlUfmiGEy5mgkfqU
</PRE>
</P>
<P>Upon its first connection to the domserver API the judgehost will be
auto-registered and will be by default enabled. If you wish to
add a new judgehost but have it initially disabled, you can add it
manually through the DOMjudge web interface and set it to disabled
before starting the judgedaemon.</P>

<H2><A NAME="ss3.14">3.14</A> <A HREF="admin-manual.html#toc3.14">Building and installing the submit client</A>
</H2>


<P>The submit client can be built with <CODE>make submitclient</CODE>. There
is no make target to install the submit client, as its location will
very much depend on the environment. You might e.g. want to copy it to
all team computers or make it available on a network filesystem. Note
that if the team computers run a different (version of the) operating
system than the jury systems, then you need to build the submit
client for that OS.</P>
<P>The submit client needs to know the address of the domserver. This
can be passed as a command line option or environment variable. The
latter option makes for easier usage. A sample script
<CODE>submit_wrapper.sh</CODE> is included, which sets this variable.
See that script for more details on how to set this up.</P>

<H3>The submit client under Windows/Cygwin</H3>


<P>The submit client can also be built under Windows when the Cygwin
environment is installed. First the Cygwin 
<A HREF="http://cygwin.com/setup.exe">setup.exe</A> program must be downloaded and
installed with GCC, curl-devel and maybe some more packages included.</P>

<P>When Cygwin is correctly installed with all necessary development
tools, the submit binary can be created by running <CODE>configure</CODE>
followed by <CODE>make submit.exe</CODE> in the <CODE>submit</CODE> directory.</P>

<H2><A NAME="ss3.15">3.15</A> <A HREF="admin-manual.html#toc3.15">(Re)generating documentation and the team manual</A>
</H2>


<P>There are three sets of documentation available under the <CODE>doc</CODE>
directory in DOMjudge:
<DL>
<DT><B>the admin-manual</B><DD>
<P>for administrators of the system (this document),</P>
<DT><B>the judge-manual</B><DD>
<P>for judges, describing the jury web interface and giving some general
information about this system,</P>
<DT><B>the team-manual</B><DD>
<P>for teams, explaining how to use the system and what restrictions
there are.</P>
</DL>
</P>

<P>The team manual is only available in PDF format and must be built from
the LaTeX sources in <CODE>doc/team</CODE> after configuration of the
system. A prebuilt team manual is included, but note that it contains
default/example values for site-specific configuration settings such
as the team web interface URL and judging settings such as the memory
limit. We strongly recommend rebuilding the team manual to include
site-specific settings and also to revise it to reflect your contest
specific environment and rules.</P>

<P>Besides a standard LaTeX installation, the team manual
requires the <CODE>svn</CODE> and <CODE>expdlist</CODE> packages. These are
available in TeX Live in the <CODE>texlive-latex-extra</CODE> package in
any modern Linux distribution. Alternatively, you can download and
install them manually from their respective subdirectories in 
<A HREF="http://mirror.ctan.org/macros/latex/contrib">http://mirror.ctan.org/macros/latex/contrib</A>.</P>

<P>When the <CODE>docs</CODE> part of DOMjudge is installed and site-specific
configuration set, the team manual can be generated with the command
<CODE>genteammanual</CODE> found under <CODE>docs/team</CODE>. The PDF
document will be placed in the current
directory or a directory given as argument. The option <CODE>-w WEBBASEURI</CODE>
can be passed to set the base URI of the DOMjudge webinterface; it
should end with a slash and defaults to <CODE>http://example.com/domjudge/</CODE>.
The following should do it on a Debian-like system:
<HR>
<PRE>
sudo apt-get install make transfig texlive-latex-extra texlive-latex-recommended
cd .../docs/team
./genteammanual [-w http://your.location.example.com/domjudge/] [targetdir]
</PRE>
<HR>
</P>

<P>The team manual is currently available in two languages: English and
Dutch. We welcome any translations to other languages.</P>

<P>The administrator's and judge's manuals are available in PDF and HTML
format and prebuilt from SGML sources. Rebuilding these is not normally
necessary. To rebuild them on a Debian-like system, the following commands
should do it:
<HR>
<PRE>
sudo apt-get install linuxdoc-tools make transfig ghostscript groff texlive-latex-recommended
make -C doc/admin docs
make -C doc/judge docs
</PRE>
<HR>
</P>


<H2><A NAME="optionalfeatures"></A> <A NAME="ss3.16">3.16</A> <A HREF="admin-manual.html#toc3.16">Optional features </A>
</H2>



<H3>Linux Control Groups (cgroups) in the judgedaemon</H3>

<P>DOMjudge has experimental support for using Linux Control Groups or cgroups
for process isolation in the judgedaemon. Using cgroups gives more accurate
measurement of actually allocated memory, which is helpful with interpreters
like Java that reserve but not actually use lots of memory. Also, the feature
will restrict network access so no separate measures are necessary, and allows
to run multiple judgedaemons on a multi-core machine.</P>

<P>The judgedaemon needs to run a recent Linux kernel (at least 3.2.0). The
following steps configure cgroups on Debian wheezy. Instructions for other
distributions may be different (send us your feedback!).</P>

<P>
<UL>
<LI> Install the necessary packages:
<CODE># apt-get install libcgroup-dev cgroup-bin</CODE></LI>
<LI> Edit grub config to add memory cgroup and swap accounting to the boot options. Edit <CODE>/etc/default/grub</CODE> and change the default commandline to <CODE>GRUB_CMDLINE_LINUX_DEFAULT="quiet cgroup_enable=memory swapaccount=1"</CODE>.
Then run <CODE>update-grub</CODE> and reboot.</LI>
<LI> Compile DOMjudge with cgroup support. Re-run <CODE>./configure</CODE> and look for cgroup in the output. Then rebuild the runguard with <CODE>make build</CODE>.</LI>
</UL>
</P>
<P>You have now configured the system to use cgroups, but you need to create
the actual cgroups that DOMjudge will use. For that, you can use the
script under <CODE>misc-tools/create_cgroups</CODE>. Edit the script to
match your situation first.
This script needs to be re-run after each boot (e.g., add it to
the judegedaemon init script).</P>

<H3>Multiple judgedaemons per machine</H3>

<P>With cgroup support set up, as per the section above, you can run multiple
judgedaemons on one multi-cpu or multi-core machine, dedicating one cpu core
to each judgedaemon.</P>
<P>To that end, set the <CODE>cpuset.cpus</CODE> variable in
<CODE>etc/cgroup-domjudge.conf</CODE> snippet correctly, e.g. to use all
cores on a quad-core machine set it to <CODE>0-3</CODE>, and add extra
unprivileged users to the system, i.e. add users
<CODE>domjudge-run-&lt;X&gt;</CODE> (where <CODE>X</CODE> runs through
<CODE>0,1,2,3</CODE>) with <CODE>useradd</CODE> as described in section 
<A HREF="#install_config:judgehost">installation of a judgehost</A>.
Finally, start each of the judgedaemons with:
<HR>
<PRE>
$ judgedaemon -n &lt;X>
</PRE>
<HR>
</P>


<H3>NTP time synchronisation</H3>


<P>We advise to install an NTP-daemon (Network Time Protocol) to make
sure the time between domserver and team computers is in sync.</P>

<H3>Printing</H3>


<P>It is recommended to configure the local desktop printing of team
workstations whereever possible: this has the most simple interface
and allows teams to print from within their editor.</P>

<P>If this is not feasible, DOMjudge includes support for printing via
the DOMjudge web interface: the DOMjudge server then needs to be
able to deliver the uploaded files to the printer. It can be
enabled via the <CODE>enable_printing</CODE> configuration option in
the administrator interface. The exact command used to send the
files to a printer can be changed the function <CODE>send_print()</CODE>
in <CODE>lib/www/printing.php</CODE>.</P>

<H3>The plugin web interface</H3>


<P>Next to the public, team and jury web interfaces, DOMjudge also
provides a <EM>plugin</EM> web interface. This web interface is still in
beta/development so subject to change. The interface provides contest data
from DOMjudge in XML format and is meant to provide external programs
(plugins) with data on the contest. This allows for all kinds of
extensions beyond the core functionality of DOMjudge such as providing
a fancy scoreboard with more statistics, aggregation of scoreboard
data for a final presentation during the prize ceremony.</P>
<P>As we are still thinking about possible uses and thus the data to be
provided, the exact specification of this interface may change. Also,
we are especially interested in feedback and ideas.</P>
<P>There are currently two data-sets provided within the <CODE>plugin</CODE>
subdirectory of the DOMjudge web interface, both in XML format:
<DL>
<DT><B><CODE>scoreboard.php</CODE></B><DD>
<P>This page provides a representation of the scoreboard.
Additionally it includes legend tables for problems,
languages, affiliations and team categories. It does not
accept any arguments.</P>
<DT><B><CODE>event.php</CODE></B><DD>
<P>This page provides a representation of events that happened
during the contest, including submissions, judgings, contest
state changes and general clarifications. This page accepts
two arguments <CODE>fromid</CODE> and <CODE>toid</CODE> to limit the
output to events with event ID in that range.</P>
</DL>

See these pages or the accompanying <CODE>xsd</CODE>-files for the exact
structure.</P>
<P>A nice example plugin is 
<A HREF="https://github.com/nickygerritsen/DOMjura">DOMjura</A>
by Nicky Gerritsen. This provides a graphical resolver of the
scoreboard from the freeze time until end of contest and can be used
during the final prize ceremony. It is a reimplementation of the
resolver made by Tim deBoer for the ICPC World Finals.</P>

<H2><A NAME="ss3.17">3.17</A> <A HREF="admin-manual.html#toc3.17">Upgrading</A>
</H2>


<P>There is some support to upgrade DOMjudge to newer versions. Note that
this functionality is not extensively tested, so when you plan to
upgrade, <EM>you are strongly advised to backup the DOMjudge database
and other data before continuing</EM>. We also advise to check the
<CODE>ChangeLog</CODE> file for important changes.</P>
<P>Upgrading the filesystem installation is probably best done by
installing the new version of DOMjudge in a separate place and
transferring the configuration settings from the old version.</P>
<P>There are SQL upgrade scripts to transform the database including its
data to the layout of a newer version. The scripts can be found under
<CODE>sql/upgrade</CODE> and each script applies changes between two
consecutive DOMjudge versions. At the beginning of each script, a check
is performed which will let MySQL bail out with an error if it should
not be applied anymore. Note that the scripts must be applied in order
(sorted by release). These scripts can be applied by running
<CODE>dj-setup-database upgrade</CODE>.</P>


<HR>
<A HREF="admin-manual-4.html">Next</A>
<A HREF="admin-manual-2.html">Previous</A>
<A HREF="admin-manual.html#toc3">Contents</A>
</BODY>
</HTML>
